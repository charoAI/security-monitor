<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GardaWorld Intelligence Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            height: 80px;
            width: auto;
        }

        .header-text {
            display: flex;
            flex-direction: column;
        }

        .header-right {
            text-align: right;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            .header-left {
                flex-direction: column;
                margin-bottom: 10px;
            }
            .header-right {
                text-align: center;
            }
            .logo {
                height: 60px;
            }
        }
        
        h1 {
            color: #e31e24;
            font-size: 2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #5a5a5a;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
            display: block;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            background: #f7fafc;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }
        
        .checkbox-item input {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .btn {
            background: #e31e24;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #c91118;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(227, 30, 36, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 15px 20px;
            border-radius: 8px;
            flex: 1;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .article {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .article:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .article-title {
            color: #2d3748;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .article-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .meta-item {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .type-cyber { background: #bee3f8; color: #2c5282; }
        .type-government { background: #fbb6ce; color: #702459; }
        .type-geopolitical { background: #c6f6d5; color: #22543d; }
        .type-analysis { background: #fed7d7; color: #742a2a; }
        
        .article-summary {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .article-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .article-link:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Synthesized Report Styles */
        .country-report {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .country-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #e2e8f0;
        }

        .country-name {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
        }

        .threat-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .threat-critical { background: #fed7d7; color: #742a2a; }
        .threat-high { background: #feebc8; color: #7c2d12; }
        .threat-moderate { background: #fef5c3; color: #744210; }
        .threat-low { background: #c6f6d5; color: #22543d; }
        .threat-minimal { background: #e6fffa; color: #234e52; }

        .executive-summary {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .summary-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .summary-text {
            color: #2d3748;
            line-height: 1.8;
            font-size: 1.05rem;
        }

        .report-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .key-points {
            list-style: none;
            padding: 0;
        }

        .key-point {
            padding: 12px;
            background: #f7fafc;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
            border-radius: 4px;
        }

        .themes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .theme-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .theme-name {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .theme-count {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .report-meta {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 0.9rem;
        }

        /* Chat Interface */
        .chat-section {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .chat-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-button:hover {
            transform: translateY(-2px);
        }

        .chat-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: #edf2f7;
            margin-left: 20%;
        }

        .chat-message.analyst {
            background: linear-gradient(135deg, #f7fafc 0%, #ffffff 100%);
            border-left: 3px solid #667eea;
            margin-right: 10%;
        }

        .message-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #718096;
            margin-bottom: 5px;
        }

        .message-text {
            color: #2d3748;
            line-height: 1.6;
        }

        .typing-indicator {
            display: inline-block;
            padding: 8px 12px;
            background: #e2e8f0;
            border-radius: 15px;
            font-style: italic;
            color: #718096;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            margin-bottom: -1px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #e31e24;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #e31e24;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tab.active {
            background: #e31e24;
            color: white;
        }

        .tab:hover {
            background: #e31e24;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Source Management */
        .source-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .source-url {
            color: #718096;
            font-size: 0.9rem;
        }

        .source-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-toggle {
            background: #48bb78;
            color: white;
        }

        .btn-toggle.inactive {
            background: #cbd5e0;
        }

        .btn-blacklist {
            background: #f56565;
            color: white;
        }

        .btn-delete {
            background: #e53e3e;
            color: white;
        }

        .add-source-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .input-field {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Select2 Custom Styling */
        .select2-container--default .select2-selection--multiple {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 45px;
            padding: 5px;
        }

        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #667eea;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            padding: 5px 10px;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white;
            margin-right: 5px;
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .country-select-container {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="/static/images/gardaworld-logo.png" alt="GardaWorld" class="logo">
                <div class="header-text">
                    <h1>Intelligence Dashboard</h1>
                    <div class="subtitle">Integrity • Trust • Vigilance • Respect</div>
                </div>
            </div>
            <div class="header-right">
                <div class="subtitle">Real-time security & geopolitical monitoring</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('report')">Intelligence Report</button>
            <button class="tab" onclick="switchTab('sources')">Manage Sources</button>
            <button class="tab" onclick="switchTab('scheduled')">Scheduled Reports</button>
        </div>

        <div id="reportTab" class="tab-content active">
        <div class="controls">
            <div class="control-group country-select-container">
                <label class="control-label">Filter by Countries (type to search)</label>
                <select id="countrySelect" multiple="multiple" style="width: 100%">
                </select>
                <small style="color: #718096; margin-top: 5px; display: block;">Start typing to search for countries. Select multiple countries to filter news. Leave empty to see all articles.</small>
            </div>

            <button class="btn" onclick="fetchSynthesizedReport()">Generate Intelligence Report</button>
            <button class="btn" style="background: #48bb78; margin-left: 10px;" onclick="fetchNews()">Simple Article List</button>
            <button class="btn" style="background: #718096; margin-left: 10px;" onclick="fetchNews(true)">Show All Articles (No Filter)</button>
        </div>
        
        <div class="content">
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-label">Articles Found</div>
                    <div class="stat-value" id="articleCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Updated</div>
                    <div class="stat-value" id="lastUpdated">-</div>
                </div>
            </div>
            
            <div id="articles">
                <p style="text-align: center; color: #718096; padding: 40px;">
                    Select your filters and click "Generate Report" to begin
                </p>
            </div>
        </div>
        </div>

        <div id="sourcesTab" class="tab-content">
            <div class="controls">
                <h2>Add New Source</h2>
                <div class="add-source-form">
                    <input type="text" id="sourceName" class="input-field" placeholder="Source Name">
                    <input type="text" id="sourceUrl" class="input-field" placeholder="RSS Feed URL">
                    <select id="sourceType" class="input-field" style="flex: 0.3">
                        <option value="general">General</option>
                        <option value="cyber">Cyber</option>
                        <option value="government">Government</option>
                        <option value="geopolitical">Geopolitical</option>
                        <option value="news">News</option>
                        <option value="analysis">Analysis</option>
                    </select>
                    <button class="btn" onclick="addSource()">Add Source</button>
                </div>
            </div>

            <div class="content">
                <h2>Current Sources</h2>
                <div id="sourcesList">
                    <div class="loading"><div class="spinner"></div>Loading sources...</div>
                </div>
            </div>
        </div>

        <!-- Scheduled Reports Tab -->
        <div id="scheduledTab" class="tab-content">
            <div class="controls">
                <h2>Create Scheduled Report</h2>
                <div class="scheduled-report-form">
                    <div class="control-group">
                        <label class="control-label">Report Name</label>
                        <input type="text" id="reportName" class="input-field" placeholder="e.g., Daily Middle East Security Brief">
                    </div>

                    <div class="control-group">
                        <label class="control-label">Countries (select multiple)</label>
                        <select id="reportCountries" multiple="multiple" style="width: 100%">
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Intelligence Focus (optional prompt for AI)</label>
                        <textarea id="reportPrompt" class="input-field" rows="3" placeholder="e.g., Focus on military movements, terrorist activities, and political instability. Look for signs of escalation or de-escalation in conflicts. Identify emerging security threats."></textarea>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Schedule</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="scheduleType" class="input-field" style="flex: 1">
                                <option value="hourly">Hourly (last 1 hour)</option>
                                <option value="daily">Daily (last 24 hours)</option>
                                <option value="weekly">Weekly (last 7 days)</option>
                                <option value="monthly">Monthly (last 30 days)</option>
                            </select>
                            <input type="time" id="scheduleTime" class="input-field" style="flex: 1" value="12:00">
                            <select id="scheduleTimezone" class="input-field" style="flex: 1">
                                <optgroup label="Americas">
                                    <option value="America/New_York">New York (EST/EDT)</option>
                                    <option value="America/Chicago">Chicago (CST/CDT)</option>
                                    <option value="America/Denver">Denver (MST/MDT)</option>
                                    <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                                    <option value="America/Toronto">Toronto</option>
                                    <option value="America/Vancouver">Vancouver</option>
                                    <option value="America/Mexico_City">Mexico City</option>
                                    <option value="America/Sao_Paulo">São Paulo</option>
                                    <option value="America/Buenos_Aires">Buenos Aires</option>
                                    <option value="America/Bogota">Bogotá</option>
                                    <option value="America/Lima">Lima</option>
                                    <option value="America/Caracas">Caracas</option>
                                    <option value="America/Halifax">Halifax</option>
                                    <option value="America/St_Johns">St. John's</option>
                                </optgroup>
                                <optgroup label="Europe">
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Europe/Berlin">Berlin</option>
                                    <option value="Europe/Rome">Rome</option>
                                    <option value="Europe/Madrid">Madrid</option>
                                    <option value="Europe/Amsterdam">Amsterdam</option>
                                    <option value="Europe/Brussels">Brussels</option>
                                    <option value="Europe/Vienna">Vienna</option>
                                    <option value="Europe/Warsaw">Warsaw</option>
                                    <option value="Europe/Moscow">Moscow</option>
                                    <option value="Europe/Kiev">Kyiv</option>
                                    <option value="Europe/Istanbul">Istanbul</option>
                                    <option value="Europe/Athens">Athens</option>
                                    <option value="Europe/Stockholm">Stockholm</option>
                                    <option value="Europe/Oslo">Oslo</option>
                                    <option value="Europe/Copenhagen">Copenhagen</option>
                                    <option value="Europe/Helsinki">Helsinki</option>
                                    <option value="Europe/Zurich">Zurich</option>
                                    <option value="Europe/Dublin">Dublin</option>
                                    <option value="Europe/Lisbon">Lisbon</option>
                                </optgroup>
                                <optgroup label="Asia">
                                    <option value="Asia/Dubai">Dubai</option>
                                    <option value="Asia/Singapore">Singapore</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                    <option value="Asia/Shanghai">Shanghai</option>
                                    <option value="Asia/Hong_Kong">Hong Kong</option>
                                    <option value="Asia/Seoul">Seoul</option>
                                    <option value="Asia/Bangkok">Bangkok</option>
                                    <option value="Asia/Jakarta">Jakarta</option>
                                    <option value="Asia/Manila">Manila</option>
                                    <option value="Asia/Kuala_Lumpur">Kuala Lumpur</option>
                                    <option value="Asia/Taipei">Taipei</option>
                                    <option value="Asia/Kolkata">Mumbai/Delhi</option>
                                    <option value="Asia/Karachi">Karachi</option>
                                    <option value="Asia/Dhaka">Dhaka</option>
                                    <option value="Asia/Baghdad">Baghdad</option>
                                    <option value="Asia/Jerusalem">Jerusalem</option>
                                    <option value="Asia/Tehran">Tehran</option>
                                    <option value="Asia/Riyadh">Riyadh</option>
                                    <option value="Asia/Kuwait">Kuwait</option>
                                    <option value="Asia/Doha">Doha</option>
                                    <option value="Asia/Beirut">Beirut</option>
                                    <option value="Asia/Damascus">Damascus</option>
                                    <option value="Asia/Kabul">Kabul</option>
                                </optgroup>
                                <optgroup label="Africa">
                                    <option value="Africa/Cairo">Cairo</option>
                                    <option value="Africa/Lagos">Lagos</option>
                                    <option value="Africa/Johannesburg">Johannesburg</option>
                                    <option value="Africa/Nairobi">Nairobi</option>
                                    <option value="Africa/Casablanca">Casablanca</option>
                                    <option value="Africa/Algiers">Algiers</option>
                                    <option value="Africa/Tunis">Tunis</option>
                                    <option value="Africa/Addis_Ababa">Addis Ababa</option>
                                    <option value="Africa/Khartoum">Khartoum</option>
                                    <option value="Africa/Mogadishu">Mogadishu</option>
                                    <option value="Africa/Tripoli">Tripoli</option>
                                    <option value="Africa/Kinshasa">Kinshasa</option>
                                    <option value="Africa/Accra">Accra</option>
                                    <option value="Africa/Dakar">Dakar</option>
                                </optgroup>
                                <optgroup label="Oceania">
                                    <option value="Australia/Sydney">Sydney</option>
                                    <option value="Australia/Melbourne">Melbourne</option>
                                    <option value="Australia/Brisbane">Brisbane</option>
                                    <option value="Australia/Perth">Perth</option>
                                    <option value="Pacific/Auckland">Auckland</option>
                                    <option value="Pacific/Fiji">Fiji</option>
                                    <option value="Pacific/Port_Moresby">Port Moresby</option>
                                </optgroup>
                                <optgroup label="UTC">
                                    <option value="UTC">UTC/GMT</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Email Recipients (optional, comma-separated)</label>
                        <input type="text" id="emailRecipients" class="input-field" placeholder="e.g., analyst@gardaworld.com, security@company.com">
                    </div>

                    <button class="btn" onclick="createScheduledReport()">Create Scheduled Report</button>
                </div>
            </div>

            <div class="content">
                <h2>Existing Scheduled Reports</h2>
                <div id="scheduledReportsList">
                    <div class="loading"><div class="spinner"></div>Loading scheduled reports...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Initialize on page load
        $(document).ready(function() {
            loadCountries();
            loadSources();
        });

        function loadCountries() {
            fetch('/api/countries')
                .then(response => response.json())
                .then(countries => {
                    const select = $('#countrySelect');
                    countries.forEach(country => {
                        select.append(new Option(country, country));
                    });

                    // Initialize Select2 with better settings
                    select.select2({
                        placeholder: 'Select countries to filter news...',
                        allowClear: true,
                        closeOnSelect: false,
                        tags: false,
                        // Clear search box after selection
                        templateSelection: function (data) {
                            return data.text;
                        }
                    });

                    // Clear search input after selecting
                    select.on('select2:select', function (e) {
                        $(this).val($(this).val()); // Keep selections
                        $('.select2-search__field').val(''); // Clear search box
                    });
                });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            if (tabName === 'report') {
                document.getElementById('reportTab').classList.add('active');
            } else if (tabName === 'sources') {
                document.getElementById('sourcesTab').classList.add('active');
                loadSources();
            } else if (tabName === 'scheduled') {
                document.getElementById('scheduledTab').classList.add('active');
                loadScheduledReports();
                initScheduledReportsSelect();
            }
        }

        async function loadSources() {
            try {
                const response = await fetch('/api/sources');
                const data = await response.json();

                let html = '';
                data.sources.forEach(source => {
                    const isActive = source.active !== false;
                    const isBlacklisted = data.blacklist && data.blacklist.includes(source.url);

                    html += `
                        <div class="source-item">
                            <div class="source-info">
                                <div class="source-name">${source.name}</div>
                                <div class="source-url">${source.url}</div>
                                <span class="type-badge type-${source.type}">${source.type}</span>
                            </div>
                            <div class="source-actions">
                                <button class="btn-small btn-toggle ${!isActive ? 'inactive' : ''}"
                                        onclick="toggleSource(${source.id})">
                                    ${isActive ? 'Active' : 'Inactive'}
                                </button>
                                ${!isBlacklisted ? `<button class="btn-small btn-blacklist" onclick="blacklistSource(${source.id})">Blacklist</button>` : '<span style="color: red;">Blacklisted</span>'}
                                <button class="btn-small btn-delete" onclick="deleteSource(${source.id})">Delete</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('sourcesList').innerHTML = html;
            } catch (error) {
                console.error('Error loading sources:', error);
            }
        }

        async function addSource() {
            const name = document.getElementById('sourceName').value;
            const url = document.getElementById('sourceUrl').value;
            const type = document.getElementById('sourceType').value;

            if (!name || !url) {
                alert('Please enter both name and URL');
                return;
            }

            try {
                const response = await fetch('/api/sources', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, url, type})
                });

                if (response.ok) {
                    document.getElementById('sourceName').value = '';
                    document.getElementById('sourceUrl').value = '';
                    loadSources();
                }
            } catch (error) {
                console.error('Error adding source:', error);
            }
        }

        async function toggleSource(id) {
            try {
                await fetch(`/api/sources/${id}/toggle`, {method: 'POST'});
                loadSources();
            } catch (error) {
                console.error('Error toggling source:', error);
            }
        }

        async function blacklistSource(id) {
            if (confirm('Are you sure you want to blacklist this source?')) {
                try {
                    await fetch(`/api/sources/${id}/blacklist`, {method: 'POST'});
                    loadSources();
                } catch (error) {
                    console.error('Error blacklisting source:', error);
                }
            }
        }

        async function deleteSource(id) {
            if (confirm('Are you sure you want to delete this source?')) {
                try {
                    await fetch(`/api/sources/${id}`, {method: 'DELETE'});
                    loadSources();
                } catch (error) {
                    console.error('Error deleting source:', error);
                }
            }
        }

        async function fetchSynthesizedReport() {
            const countries = $('#countrySelect').val() || [];

            if (countries.length === 0) {
                alert('Please select at least one country for the intelligence report');
                return;
            }

            document.getElementById('articles').innerHTML = '<div class="loading"><div class="spinner"></div>Generating intelligence report...</div>';

            try {
                const response = await fetch('/api/fetch_news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ countries, report_type: 'synthesized' })
                });

                const data = await response.json();

                if (data.report_type === 'synthesized') {
                    displaySynthesizedReport(data);
                }
            } catch (error) {
                document.getElementById('articles').innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 40px;">Error generating report. Please try again.</p>';
                console.error('Error:', error);
            }
        }

        function formatNarrative(narrative) {
            // Convert markdown-style headers to HTML
            return narrative
                .replace(/\*\*(.+?)\*\*/g, '<strong style="display: block; margin-top: 20px; margin-bottom: 10px; color: #2d3748; font-size: 1.1rem;">$1</strong>')
                .replace(/\n\n/g, '</p><p style="margin-bottom: 15px;">')
                .replace(/^/, '<p style="margin-bottom: 15px;">')
                .replace(/$/, '</p>');
        }

        // Store country contexts globally for chat
        let countryContexts = {};

        function displaySynthesizedReport(data) {
            let html = '';

            // Store contexts for chat functionality
            for (const [country, report] of Object.entries(data.country_reports)) {
                // Store narrative and articles for context
                countryContexts[country] = {
                    narrative: report.narrative || '',
                    articles: report.detailed_articles || []
                };
            }

            // Display each country's report
            for (const [country, report] of Object.entries(data.country_reports)) {
                const threatClass = `threat-${report.threat_level.toLowerCase()}`;

                html += `
                    <div class="country-report">
                        <div class="country-header">
                            <div class="country-name">🌍 ${country}</div>
                            <div class="threat-badge ${threatClass}">Threat Level: ${report.threat_level}</div>
                        </div>

                        <div style="background: linear-gradient(135deg, #f7fafc 0%, #ffffff 100%); border: 1px solid #e2e8f0; padding: 30px; border-radius: 12px; margin-bottom: 25px;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                                Intelligence Assessment: ${country}
                            </h2>
                            <div style="color: #4a5568; line-height: 1.9; font-size: 1.05rem;">
                                ${formatNarrative(report.narrative)}
                            </div>
                        </div>

                        ${Object.keys(report.themes).length > 0 ? `
                            <div class="report-section">
                                <div class="section-title">📊 Thematic Analysis</div>
                                <div class="themes-grid">
                                    ${Object.entries(report.themes).map(([theme, count]) => `
                                        <div class="theme-card">
                                            <div class="theme-name">${theme}</div>
                                            <div class="theme-count">${count}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <div class="report-meta">
                            <span>📰 ${report.article_count} articles analyzed</span>
                            <span>📡 ${report.sources.length} sources monitored</span>
                            <span>⏰ Generated: ${data.timestamp}</span>
                        </div>

                        <details style="margin-top: 20px;">
                            <summary style="cursor: pointer; color: #667eea; font-weight: 600;">View Source Articles</summary>
                            <div style="margin-top: 15px;">
                                ${report.detailed_articles.map(article => `
                                    <div class="article" style="margin-top: 10px;">
                                        <div class="article-title">${article.title}</div>
                                        <div class="article-meta">
                                            <span class="meta-item">📰 ${article.source}</span>
                                        </div>
                                        <a href="${article.link}" target="_blank" class="article-link">Read full article →</a>
                                    </div>
                                `).join('')}
                            </div>
                        </details>

                        <div class="chat-section">
                            <div class="chat-title">💬 Ask the Analyst</div>
                            <div class="chat-messages" id="chat-messages-${country.replace(/\s/g, '-')}">
                                <div class="chat-message analyst">
                                    <div class="message-label">Intelligence Analyst</div>
                                    <div class="message-text">I'm ready to answer questions about ${country}'s current situation based on the intelligence we've gathered. What would you like to know?</div>
                                </div>
                            </div>
                            <div class="chat-input-group">
                                <input type="text"
                                       class="chat-input"
                                       id="chat-input-${country.replace(/\s/g, '-')}"
                                       placeholder="Ask about ${country}'s security situation, political developments, risks..."
                                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); sendChatMessage('${country}'); }">
                                <button class="chat-button"
                                        id="chat-button-${country.replace(/\s/g, '-')}"
                                        onclick="sendChatMessage('${country}')">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update stats
            document.getElementById('stats').style.display = 'flex';
            document.getElementById('articleCount').textContent = data.total_articles;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();

            document.getElementById('articles').innerHTML = html;
        }

        async function sendChatMessage(country) {
            console.log('Sending chat message for:', country);

            const countryId = country.replace(/\s/g, '-');
            const messagesDiv = document.getElementById(`chat-messages-${countryId}`);
            const inputField = document.getElementById(`chat-input-${countryId}`);
            const question = inputField.value.trim();

            if (!question) {
                console.log('No question provided');
                return;
            }

            console.log('Question:', question);

            // Add user message
            messagesDiv.innerHTML += `
                <div class="chat-message user">
                    <div class="message-label">You</div>
                    <div class="message-text">${question}</div>
                </div>
            `;

            // Clear input
            inputField.value = '';

            // Add typing indicator
            messagesDiv.innerHTML += `
                <div class="typing-indicator" id="typing-${countryId}">
                    Intelligence analyst is thinking...
                </div>
            `;

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // Get context for this country
                const countryContext = countryContexts[country] || {};
                const contextText = countryContext.narrative || 'No context available';

                console.log('Sending to API...');
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        country: country,
                        question: question,
                        context: contextText.substring(0, 3000)  // Limit context size
                    })
                });

                console.log('Response status:', response.status);

                const data = await response.json();

                // Remove typing indicator
                const typingIndicator = document.getElementById(`typing-${countryId}`);
                if (typingIndicator) typingIndicator.remove();

                // Add analyst response
                messagesDiv.innerHTML += `
                    <div class="chat-message analyst">
                        <div class="message-label">Intelligence Analyst</div>
                        <div class="message-text">${data.answer}</div>
                    </div>
                `;

                // Scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

            } catch (error) {
                // Remove typing indicator
                const typingIndicator = document.getElementById(`typing-${countryId}`);
                if (typingIndicator) typingIndicator.remove();

                messagesDiv.innerHTML += `
                    <div class="chat-message analyst">
                        <div class="message-label">System</div>
                        <div class="message-text" style="color: #e53e3e;">
                            Sorry, I couldn't process your question. Please try again.
                        </div>
                    </div>
                `;
            }
        }

        async function fetchNews(showAll = false) {
            const countries = showAll ? [] : ($('#countrySelect').val() || []);
            
            document.getElementById('articles').innerHTML = '<div class="loading"><div class="spinner"></div>Fetching latest intelligence...</div>';
            
            try {
                const response = await fetch('/api/fetch_news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ countries })
                });
                
                const data = await response.json();
                
                // Update stats
                document.getElementById('stats').style.display = 'flex';
                document.getElementById('articleCount').textContent = data.count;
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                
                // Display articles
                if (data.articles.length === 0) {
                    document.getElementById('articles').innerHTML = '<p style="text-align: center; color: #718096; padding: 40px;">No articles found matching your criteria. Try adjusting your filters.</p>';
                } else {
                    let html = '';
                    data.articles.forEach(article => {
                        html += `
                            <div class="article">
                                <div class="article-header">
                                    <div>
                                        <div class="article-title">${article.title}</div>
                                        <div class="article-meta">
                                            <span class="meta-item">📰 ${article.source}</span>
                                            <span class="type-badge type-${article.type}">${article.type}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="article-summary">${article.summary}...</div>
                                <a href="${article.link}" target="_blank" class="article-link">
                                    Read full article →
                                </a>
                            </div>
                        `;
                    });
                    document.getElementById('articles').innerHTML = html;
                }
            } catch (error) {
                document.getElementById('articles').innerHTML = '<p style="text-align: center; color: #e53e3e; padding: 40px;">Error fetching data. Please try again.</p>';
                console.error('Error:', error);
            }
        }

        // Scheduled Reports Functions
        async function initScheduledReportsSelect() {
            try {
                // Fetch countries list
                const response = await fetch('/api/countries');
                const countries = await response.json();

                // Initialize the select2 dropdown
                $('#reportCountries').select2({
                    placeholder: 'Select countries to monitor',
                    allowClear: true,
                    data: countries.map(c => ({ id: c, text: c })),
                    width: '100%'
                });
            } catch (error) {
                console.error('Error loading countries for scheduled reports:', error);
            }
        }

        async function loadScheduledReports() {
            try {
                const response = await fetch('/api/scheduled-reports');
                const reports = await response.json();

                const container = document.getElementById('scheduledReportsList');

                if (reports.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #718096;">No scheduled reports configured.</p>';
                    return;
                }

                container.innerHTML = reports.map(report => `
                    <div class="source-item ${report.is_active ? '' : 'inactive'}">
                        <div class="source-info">
                            <div class="source-name">${report.name}</div>
                            <div class="source-url">
                                Countries: ${report.countries.join(', ')}<br>
                                Schedule: ${report.schedule_type} at ${report.schedule_time} ${report.timezone}<br>
                                Next run: ${report.next_run ? new Date(report.next_run).toLocaleString() : 'N/A'}
                                ${report.prompt ? `<br>Focus: ${report.prompt.substring(0, 100)}${report.prompt.length > 100 ? '...' : ''}` : ''}
                            </div>
                        </div>
                        <div class="source-actions">
                            <button class="btn btn-small" onclick="runReportNow(${report.id})" title="Run Now">▶</button>
                            <button class="btn btn-small ${report.is_active ? 'btn-active' : 'btn-inactive'}"
                                    onclick="toggleScheduledReport(${report.id})">
                                ${report.is_active ? 'Active' : 'Inactive'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteScheduledReport(${report.id})">Delete</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading scheduled reports:', error);
                document.getElementById('scheduledReportsList').innerHTML =
                    '<p style="text-align: center; color: #e53e3e;">Error loading scheduled reports.</p>';
            }
        }

        async function createScheduledReport() {
            const name = document.getElementById('reportName').value.trim();
            const countries = $('#reportCountries').val() || [];
            const prompt = document.getElementById('reportPrompt').value.trim();
            const scheduleType = document.getElementById('scheduleType').value;
            const scheduleTime = document.getElementById('scheduleTime').value;
            const timezone = document.getElementById('scheduleTimezone').value;
            const emailRecipients = document.getElementById('emailRecipients').value
                .split(',')
                .map(e => e.trim())
                .filter(e => e);

            if (!name) {
                alert('Please enter a report name');
                return;
            }

            if (countries.length === 0) {
                alert('Please select at least one country');
                return;
            }

            try {
                const response = await fetch('/api/scheduled-reports', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name,
                        countries,
                        prompt,
                        schedule_type: scheduleType,
                        schedule_time: scheduleTime,
                        timezone,
                        email_recipients: emailRecipients
                    })
                });

                if (response.ok) {
                    alert('Scheduled report created successfully!');
                    document.getElementById('reportName').value = '';
                    $('#reportCountries').val(null).trigger('change');
                    document.getElementById('reportPrompt').value = '';
                    document.getElementById('emailRecipients').value = '';
                    loadScheduledReports();
                } else {
                    alert('Failed to create scheduled report');
                }
            } catch (error) {
                console.error('Error creating scheduled report:', error);
                alert('Error creating scheduled report');
            }
        }

        async function toggleScheduledReport(reportId) {
            try {
                const response = await fetch(`/api/scheduled-reports/${reportId}/toggle`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadScheduledReports();
                }
            } catch (error) {
                console.error('Error toggling report:', error);
            }
        }

        async function deleteScheduledReport(reportId) {
            if (!confirm('Are you sure you want to delete this scheduled report?')) {
                return;
            }

            try {
                const response = await fetch(`/api/scheduled-reports/${reportId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadScheduledReports();
                }
            } catch (error) {
                console.error('Error deleting report:', error);
            }
        }

        async function runReportNow(reportId) {
            if (!confirm('Run this report now? This will generate and send the report immediately.')) {
                return;
            }

            try {
                const response = await fetch(`/api/scheduled-reports/${reportId}/run`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Report is being generated and will be sent shortly.');
                } else {
                    alert('Failed to run report');
                }
            } catch (error) {
                console.error('Error running report:', error);
                alert('Error running report');
            }
        }
    </script>
</body>
</html>